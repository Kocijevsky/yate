#!/usr/bin/env node

//  ---------------------------------------------------------------------------------------------------------------  //

var fs_ = require('fs');
var path_ = require('path');

var nopt = require('nopt');

//  ---------------------------------------------------------------------------------------------------------------  //

var yate = require('./lib/index.js');

//  ---------------------------------------------------------------------------------------------------------------  //

var options = get_options();

var compiler = new yate.Compiler({
    include_dir: options.include_dir
});

if (options.help) {
    help();

} else if (options.version) {
    version();

} else if (options.print) {
    print();

} else if (options.data) {
    run();

} else if (options.ast_before || options.ast_after) {
    ast();

} else if (options.files.length) {
    compile();

} else {
    help();

}

//  ---------------------------------------------------------------------------------------------------------------  //

function get_options() {
    var options = nopt(
        {
            'help': Boolean,
            'version': Boolean,
            'ast_before': Boolean,
            'ast_after': Boolean,
            'print': Boolean,

            'mode': String,
            'data': String,
            'externals': [ Array, path_ ],
            'target': String,
            'stdout': Boolean,
            'include_dir': [ Array, path_ ],
        },
        {
            'p': '--print',
            'm': '--mode',
            'e': '--externals',
            'a': '--ast_before',
            'ast': '--ast_before',
            'v': '--version',
            'I': 'include_dir',
            'node': [ '--target', 'node' ],
        }
    );

    var remain = options.argv.remain;

    if ( is_yate(remain) ) {
        options.files = remain;

    } else {
        var arg0 = remain[0];
        if ( !is_yate(arg0) ) {
            return help();
        }
        options.files = [ arg0 ];

        options.data = remain[1];

        if ( remain.length > 2 ) {
            return help();
        }
    }

    options.include_dir = options.include_dir || [];
    options.include_dir.push( path_.resolve('.') );

    var files = options.files;
    //  FIXME: А нужно ли это? Кажется, нода сама эти параметры резолвит.
    for (var i = 0, l = files.length; i < l; i++) {
        //  console.error( files[i] );
        files[i] = path_.resolve( '.', files[i] );
    }

    var data = options.data;
    if (data) {
        options.target = 'node';

        if ( typeof data === 'string' ) {
            if ( data.charAt(0) === '{' || data.charAt(0) === '[' ) {
                options.data = eval( '(' + data + ')' );
            } else {
                options.data = eval( '(' + fs_.readFileSync(data, 'utf-8') + ')' );
            }
        }
    }

    return options;
}

function is_yate(s) {
    if ( Array.isArray(s) ) {
        for (var i = 0, l = s.length; i < l; i++) {
            if ( !is_yate( s[i] ) ) {
                return false;
            }
        }
        return true;
    }

    return /\.yate$/.test(s);
}


//  ---------------------------------------------------------------------------------------------------------------  //

function help() {
    console.log( fs_.readFileSync(__dirname + '/lib/usage.txt', 'utf-8') );

    process.exit(1);
};

//  ---------------------------------------------------------------------------------------------------------------  //

function version() {
    console.log( require('../package.json').version );
};

//  ---------------------------------------------------------------------------------------------------------------  //

function print() {
    var filename = options.files[0];

    var ast = compiler.parse(filename);

    console.log( ast.yate() );
};

//  ---------------------------------------------------------------------------------------------------------------  //

function ast() {
    var filename = options.files[0];
    var ast = (options.ast_after) ? compiler.ast_after(filename) : compiler.ast_before(filename);

    console.log( ast.toString() );
};

//  ---------------------------------------------------------------------------------------------------------------  //

function run() {
    var filename = options.files[0];
    compile(filename);

    var module_name = filename + '.node.js';
    var module = require(module_name);

    var result = module(options.data, options.mode);

    console.log(result);
};

//  ---------------------------------------------------------------------------------------------------------------  //

function compile() {
    if (options.stdout) {
        compile_to_stdout( options.files[0] );
    } else {
        compile_to_file();
    }
}

function compile_to_string(filename) {
    var js = compiler.compile_to_string(filename, options);

    return js;
}

function compile_to_stdout(filename) {
    var js = compile_to_string(filename);

    console.log(js);
}

function compile_to_file() {
    var files = options.files;

    for (var i = 0, l = files.length; i < l; i++) {
        var filename = files[i];

        compiler.compile_to_file(filename, options);
    }
}

//  ---------------------------------------------------------------------------------------------------------------  //

// vim: set filetype=javascript:

